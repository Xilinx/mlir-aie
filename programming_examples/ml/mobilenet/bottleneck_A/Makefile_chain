#
# This file is licensed under the Apache License v2.0 with LLVM Exceptions.
# See https://llvm.org/LICENSE.txt for license information.
# SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
#
# Copyright (C) 2024, Advanced Micro Devices, Inc.
srcdir := $(shell dirname $(realpath $(firstword $(MAKEFILE_LIST))))

include ${srcdir}/../../../makefile-common

VPATH := ${srcdir}/../../../../aie_kernels/aie2

MLIR_FILE=aie2_bn_chain

OBJ = build/fused_bn0_bn1.a build/bn2_combined_con2dk1fusedrelu_conv2dk3dwstride1_conv2dk1skip.a build/bn3_combined_con2dk1fusedrelu_conv2dk3dwstride2_conv2dk1.a build/bn4_combined_con2dk1fusedrelu_conv2dk3dwstride1_conv2dk1skip.a build/bn5_combined_con2dk1fusedrelu_conv2dk3dwstride1_conv2dk1.a build/bn6_combined_con2dk1fusedrelu_conv2dk3dwstride2_conv2dk1.a build/bn7_combined_con2dk1fusedrelu_conv2dk3dwstride1_conv2dk1skip.a build/bn8_combined_con2dk1fusedrelu_conv2dk3dwstride1_conv2dk1.a build/bn9_combined_con2dk1fusedrelu_conv2dk3dwstride1_conv2dk1skip.a 
# OBJ = build/fused_bn0_bn1.a 

all: build/final_bn_chain.xclbin run_py_bn_chain

build/${MLIR_FILE}.mlir: ${srcdir}/${MLIR_FILE}.py 
	mkdir -p ${@D}
	python3 $< > $@

# bn0+bn1
build/bn0_conv2dk3_dw_stride1.o: bn_conv2dk3_dw.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DBN0  -DSCALAR  -DSTRIDE1 -c $< -o ${@F}

build/bn0_conv2dk1_skipui8.o: bn_conv2dk1_skip.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DBN0 -DSCALAR -DUNSIGNED_SKIP -c $< -o ${@F}

build/bn1_conv2dk1_fused_relu.o: bn_conv2dk1_relu.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DSCALAR -DBN1 -DINT8_ACT -c $< -o ${@F}

build/bn1_conv2dk3_dw_stride2.o: bn_conv2dk3_dw.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DBN1  -DSCALAR -DSTRIDE2 -c $< -o ${@F}

build/bn1_conv2dk1_i8.o: bn_conv2dk1_i8.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS}  -DSCALAR -DBN1 -c $< -o ${@F}

build/fused_bn0_bn1.a: build/bn0_conv2dk3_dw_stride1.o build/bn0_conv2dk1_skipui8.o build/bn1_conv2dk1_fused_relu.o build/bn1_conv2dk3_dw_stride2.o build/bn1_conv2dk1_i8.o 
	mkdir -p ${@D}
	ar rvs $@ $^ $(word 2,$^) $(word 3,$^) $(word 4,$^) $(word 5,$^)

# bn2
build/bn2_conv2dk1_fused_relu.o: bn_conv2dk1_relu.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DBN2 -DINT8_ACT -c $< -o ${@F}

build/bn2_conv2dk3_dw_stride1.o: bn_conv2dk3_dw.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DBN2  -DSCALAR  -DSTRIDE1 -c $< -o ${@F}
build/bn2_conv2dk1_skip.o: bn_conv2dk1_skip.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DBN2 -DSCALAR -c $< -o ${@F}

build/bn2_combined_con2dk1fusedrelu_conv2dk3dwstride1_conv2dk1skip.a: build/bn2_conv2dk1_fused_relu.o build/bn2_conv2dk3_dw_stride1.o build/bn2_conv2dk1_skip.o  
	mkdir -p ${@D}
	ar rvs $@ $< $(word 2,$^) $(word 3,$^)

# bn3
build/bn3_conv2dk1_fused_relu.o: bn_conv2dk1_relu.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DSCALAR -DBN3 -DINT8_ACT -c $< -o ${@F}
build/bn3_conv2dk3_dw_stride2.o: bn_conv2dk3_dw.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DBN3  -DSCALAR -DSTRIDE2 -c $< -o ${@F}
build/bn3_conv2dk1_i8.o: bn_conv2dk1_i8.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS}  -DSCALAR -DBN3 -c $< -o ${@F}

build/bn3_combined_con2dk1fusedrelu_conv2dk3dwstride2_conv2dk1.a: build/bn3_conv2dk1_fused_relu.o build/bn3_conv2dk3_dw_stride2.o build/bn3_conv2dk1_i8.o  
	mkdir -p ${@D}
	ar rvs $@ $< $(word 2,$^) $(word 3,$^)

# bn4
build/bn4_conv2dk1_fused_relu.o: bn_conv2dk1_relu.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DSCALAR -DBN4 -DINT8_ACT -c $< -o ${@F}

build/bn4_conv2dk3_dw_stride1.o: bn_conv2dk3_dw.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DBN4  -DSCALAR  -DSTRIDE1 -c $< -o ${@F}
build/bn4_conv2dk1_skip.o: bn_conv2dk1_skip.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DBN4 -DSCALAR -c $< -o ${@F}

build/bn4_combined_con2dk1fusedrelu_conv2dk3dwstride1_conv2dk1skip.a: build/bn4_conv2dk1_fused_relu.o build/bn4_conv2dk3_dw_stride1.o build/bn4_conv2dk1_skip.o  
	mkdir -p ${@D}
	ar rvs $@ $< $(word 2,$^) $(word 3,$^)

# 

# bn5
build/bn5_conv2dk1_fused_relu.o: bn_conv2dk1_relu.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DSCALAR -DBN5 -DINT8_ACT -c $< -o ${@F}

build/bn5_conv2dk3_dw_stride1.o: bn_conv2dk3_dw.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DBN5  -DSCALAR  -DSTRIDE1 -c $< -o ${@F}
# build/bn5_conv2dk1_skip.o: bn_conv2dk1_skip.cc
# 	mkdir -p ${@D}
# 	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DBN5 -DSCALAR -c $< -o ${@F}

build/bn5_conv2dk1_i8.o: bn_conv2dk1_i8.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS}  -DSCALAR -DBN5 -c $< -o ${@F}


build/bn5_combined_con2dk1fusedrelu_conv2dk3dwstride1_conv2dk1.a: build/bn5_conv2dk1_fused_relu.o build/bn5_conv2dk3_dw_stride1.o build/bn5_conv2dk1_i8.o  
	mkdir -p ${@D}
	ar rvs $@ $< $(word 2,$^) $(word 3,$^)


# bn6
build/bn6_conv2dk1_fused_relu.o: bn_conv2dk1_relu.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DSCALAR -DBN6 -DINT8_ACT -c $< -o ${@F}
build/bn6_conv2dk3_dw_stride2.o: bn_conv2dk3_dw.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DBN6  -DSCALAR -DSTRIDE2 -c $< -o ${@F}
build/bn6_conv2dk1_i8.o: bn_conv2dk1_i8.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS}  -DSCALAR -DBN6 -c $< -o ${@F}

build/bn6_combined_con2dk1fusedrelu_conv2dk3dwstride2_conv2dk1.a: build/bn6_conv2dk1_fused_relu.o build/bn6_conv2dk3_dw_stride2.o build/bn6_conv2dk1_i8.o  
	mkdir -p ${@D}
	ar rvs $@ $< $(word 2,$^) $(word 3,$^)
# bn7
build/bn7_conv2dk1_fused_relu.o: bn_conv2dk1_relu.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DSCALAR -DBN7 -DINT8_ACT -c $< -o ${@F}

build/bn7_conv2dk3_dw_stride1.o: bn_conv2dk3_dw.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DBN7  -DSCALAR  -DSTRIDE1 -c $< -o ${@F}
build/bn7_conv2dk1_skip.o: bn_conv2dk1_skip.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DBN7 -DSCALAR -c $< -o ${@F}

build/bn7_combined_con2dk1fusedrelu_conv2dk3dwstride1_conv2dk1skip.a: build/bn7_conv2dk1_fused_relu.o build/bn7_conv2dk3_dw_stride1.o build/bn7_conv2dk1_skip.o  
	mkdir -p ${@D}
	ar rvs $@ $< $(word 2,$^) $(word 3,$^)

# bn8
build/bn8_conv2dk1_fused_relu.o: bn_conv2dk1_relu.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DSCALAR -DBN8 -DINT8_ACT -c $< -o ${@F}

build/bn8_conv2dk3_dw_stride1.o: bn_conv2dk3_dw.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DBN8  -DSCALAR  -DSTRIDE1 -c $< -o ${@F}
# build/bn8_conv2dk1_skip.o: bn_conv2dk1_skip.cc
# 	mkdir -p ${@D}
# 	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DBN8 -DSCALAR -c $< -o ${@F}

build/bn8_conv2dk1_i8.o: bn_conv2dk1_i8.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS}  -DSCALAR -DBN8 -c $< -o ${@F}

build/bn8_combined_con2dk1fusedrelu_conv2dk3dwstride1_conv2dk1.a: build/bn8_conv2dk1_fused_relu.o build/bn8_conv2dk3_dw_stride1.o build/bn8_conv2dk1_i8.o  
	mkdir -p ${@D}
	ar rvs $@ $< $(word 2,$^) $(word 3,$^)

# bn9
build/bn9_conv2dk1_fused_relu.o: bn_conv2dk1_relu.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DSCALAR -DBN9 -DINT8_ACT -c $< -o ${@F}

build/bn9_conv2dk3_dw_stride1.o: bn_conv2dk3_dw.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DBN9  -DSCALAR  -DSTRIDE1 -c $< -o ${@F}
build/bn9_conv2dk1_skip.o: bn_conv2dk1_skip.cc
	mkdir -p ${@D}
	cd ${@D} && xchesscc_wrapper ${CHESSCCWRAP2_FLAGS} -DBN9 -DSCALAR -c $< -o ${@F}

build/bn9_combined_con2dk1fusedrelu_conv2dk3dwstride1_conv2dk1skip.a: build/bn9_conv2dk1_fused_relu.o build/bn9_conv2dk3_dw_stride1.o build/bn9_conv2dk1_skip.o  
	mkdir -p ${@D}
	ar rvs $@ $< $(word 2,$^) $(word 3,$^)
# ****************************************************************************************

build/final_bn_chain.xclbin: build/${MLIR_FILE}.mlir  $(OBJ)
	cd build && aiecc.py -v --aie-generate-cdo --aie-generate-npu --no-compile-host \
		--basic-alloc-scheme \
		--xclbin-name=${@F} --npu-insts-name=insts.txt ${<F}

run_py_bn_chain: 
	${powershell} python3 ${srcdir}/test_bn_chain.py -x build/final_bn_chain.xclbin -i build/insts.txt -k MLIR_AIE

# clean:
# 	rm -rf build *.elf* *.lst *.bif ${mlirFileName}.mlir.prj log .xclbin sim \
# 		chess* *.o insts.txt \
# 		*.log aie_partition.json *.bin BOOT.BIN _x test.exe
clean:
	rm -rf build/*.elf* build/*.lst build/*.bif build/*.mlir.prj build/*.mlir log build/.xclbin build/sim \
		build/insts.txt \
		build/*.log aie_partition.json build/*.bin build/BOOT.BIN _x build/test.exe